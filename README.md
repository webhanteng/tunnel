# Tunnel

åŸºäº Java/Spring Boot/WebSocket çš„å†…ç½‘ç©¿é€ä»£ç†ï¼Œæ”¯æŒ HTTP å…¨é€ä¼ ã€WebSocket éš§é“ã€å¤šå®¢æˆ·ç«¯è·¯ç”±åŠå¯ç®¡ç† UIã€‚é€‚ç”¨äºäº‘æ¡Œé¢ç½‘ç»œéš”ç¦»åœºæ™¯ã€‚

## ğŸ“„ License

MIT License - See [LICENSE](./LICENSE) file for details.

## ğŸŒŸ åŠŸèƒ½ç‰¹æ€§

- **å¤šå®¢æˆ·ç«¯æ³¨å†Œ** - æ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯æ³¨å†ŒåŒä¸€è·¯ç”±ï¼Œå®ç°è´Ÿè½½å‡è¡¡
- **HTTP å…¨é€ä¼ ** - å®Œæ•´é€ä¼  HTTP è¯·æ±‚ï¼ˆHeader + Bodyï¼‰ï¼Œæ”¯æŒæ‰€æœ‰ HTTP æ–¹æ³•
- **WebSocket éš§é“** - åŸºäº WebSocket çš„ç¨³å®šéš§é“è¿æ¥
- **è´Ÿè½½å‡è¡¡** - å†…ç½®è½®è¯¢è´Ÿè½½å‡è¡¡å™¨ï¼Œæ”¯æŒå¤šå®¢æˆ·ç«¯è¯·æ±‚åˆ†å‘
- **ç®¡ç†ç•Œé¢** - Web ç®¡ç†æ§åˆ¶å°ï¼Œå®æ—¶æŸ¥çœ‹å®¢æˆ·ç«¯å’Œè·¯ç”±çŠ¶æ€
- **å¿ƒè·³æ£€æµ‹** - è‡ªåŠ¨å¿ƒè·³æœºåˆ¶ï¼Œè¶…æ—¶è‡ªåŠ¨å‰”é™¤å¤±æ´»å®¢æˆ·ç«¯
- **è‡ªåŠ¨é‡è¿** - å®¢æˆ·ç«¯è¿æ¥æ–­å¼€åè‡ªåŠ¨é‡è¿

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ç»„ä»¶è¯´æ˜

```
å¤–éƒ¨è¯·æ±‚ â†’ Tunnel Server (ç½‘å…³) â†’ WebSocket éš§é“ â†’ Tunnel Client â†’ æœ¬åœ°æœåŠ¡
```

**Tunnel Server (æœåŠ¡ç«¯)**
- ç›‘å¬ç«¯å£ï¼š9001
- WebSocket è·¯å¾„ï¼š`/ws`
- ç½‘å…³è·¯å¾„ï¼š`/gateway/{route}/**`
- ç®¡ç†ç•Œé¢ï¼š`/admin.html`

**Tunnel Client (å®¢æˆ·ç«¯)**
- ç›‘å¬ç«¯å£ï¼š9000
- è¿æ¥åˆ°æœåŠ¡ç«¯çš„ WebSocket
- è½¬å‘è¯·æ±‚åˆ°æœ¬åœ°åç«¯æœåŠ¡

### å·¥ä½œæµç¨‹

1. å®¢æˆ·ç«¯é€šè¿‡ WebSocket è¿æ¥åˆ°æœåŠ¡ç«¯ï¼Œæºå¸¦ `route` å‚æ•°æ³¨å†Œè·¯ç”±
2. å¤–éƒ¨è¯·æ±‚å‘é€åˆ°æœåŠ¡ç«¯ç½‘å…³ï¼š`http://server:9001/gateway/{route}/path`
3. æœåŠ¡ç«¯æ ¹æ®è·¯ç”±é€‰æ‹©å®¢æˆ·ç«¯ï¼ˆè½®è¯¢è´Ÿè½½å‡è¡¡ï¼‰
4. é€šè¿‡ WebSocket å°†è¯·æ±‚è½¬å‘ç»™é€‰ä¸­çš„å®¢æˆ·ç«¯
5. å®¢æˆ·ç«¯å°†è¯·æ±‚è½¬å‘åˆ°æœ¬åœ°åç«¯æœåŠ¡
6. å®¢æˆ·ç«¯å°†å“åº”é€šè¿‡ WebSocket è¿”å›ç»™æœåŠ¡ç«¯
7. æœåŠ¡ç«¯å°†å“åº”è¿”å›ç»™å¤–éƒ¨è¯·æ±‚è€…

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- JDK 8+
- Maven 3.6+

### ç¼–è¯‘æ‰“åŒ…

```bash
# ç¼–è¯‘æœåŠ¡ç«¯
cd tunnel/tunnel-server
mvn clean package

# ç¼–è¯‘å®¢æˆ·ç«¯
cd tunnel/tunnel-client
mvn clean package
```

### å¯åŠ¨æœåŠ¡ç«¯

```bash
cd tunnel/tunnel-server
java -jar target/tunnel-server-1.0.0.jar
```

æœåŠ¡ç«¯å¯åŠ¨åï¼Œè®¿é—® `http://localhost:9001/admin.html` æ‰“å¼€ç®¡ç†ç•Œé¢ã€‚

### å¯åŠ¨å®¢æˆ·ç«¯

```bash
cd tunnel/tunnel-client
java -jar target/tunnel-client-1.0.0.jar
```

### è®¿é—®æœåŠ¡

å‡è®¾ï¼š
- æœåŠ¡ç«¯è¿è¡Œåœ¨ `127.0.0.1:9001`
- å®¢æˆ·ç«¯æ³¨å†Œè·¯ç”±ä¸º `test`
- æœ¬åœ°åç«¯æœåŠ¡è¿è¡Œåœ¨ `127.0.0.1:8080`

è®¿é—® `http://127.0.0.1:9001/gateway/test/api/users`ï¼Œè¯·æ±‚å°†è¢«è½¬å‘åˆ° `http://127.0.0.1:8080/api/users`

## âš™ï¸ é…ç½®è¯´æ˜

### æœåŠ¡ç«¯é…ç½® (tunnel-server/src/main/resources/application.yml)

```yaml
server:
  port: 9001  # æœåŠ¡ç«¯ç›‘å¬ç«¯å£

tunnel:
  ws-path: /ws        # WebSocket è¿æ¥è·¯å¾„
  gateway-path: /gateway  # ç½‘å…³è·¯å¾„
```

### å®¢æˆ·ç«¯é…ç½® (tunnel-client/src/main/resources/application.yml)

```yaml
server:
  port: 9000  # å®¢æˆ·ç«¯ HTTP æœåŠ¡ç«¯å£ï¼ˆå¯é€‰ï¼‰

tunnel:
  server-ws: ws://127.0.0.1:9001/ws?route=test  # æœåŠ¡ç«¯ WebSocket åœ°å€
  local-backend: http://127.0.0.1:8080  # æœ¬åœ°åç«¯æœåŠ¡åœ°å€
```

## ğŸ“¡ API æ–‡æ¡£

### ç®¡ç†æ¥å£

#### è·å–è·¯ç”±åˆ—è¡¨

```
GET /admin/routes
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "test": 2,
  "prod": 1
}
```

#### è·å–å®¢æˆ·ç«¯åˆ—è¡¨

```
GET /admin/clients
```

å“åº”ç¤ºä¾‹ï¼š
```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "route": "test",
    "lastHeartbeat": 1704067200000
  }
]
```

#### å¼ºåˆ¶ä¸‹çº¿è·¯ç”±

```
DELETE /admin/routes/{route}
```

#### å¼ºåˆ¶ä¸‹çº¿å®¢æˆ·ç«¯

```
DELETE /admin/clients/{clientId}
```

### ç½‘å…³æ¥å£

#### é€ä¼ è¯·æ±‚

```
{GET|POST|PUT|DELETE|PATCH|HEAD|OPTIONS} /gateway/{route}/**
```

æ”¯æŒæ‰€æœ‰ HTTP æ–¹æ³•ï¼Œå®Œæ•´é€ä¼ è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“ã€‚

## ï¿½ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šå•å®¢æˆ·ç«¯ç©¿é€

1. å¯åŠ¨æœåŠ¡ç«¯
2. å¯åŠ¨å®¢æˆ·ç«¯ï¼Œé…ç½®è·¯ç”±ä¸º `myapp`
3. è®¿é—® `http://server:9001/gateway/myapp/` å³å¯è®¿é—®æœ¬åœ°æœåŠ¡

### ç¤ºä¾‹ 2ï¼šå¤šå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡

1. å¯åŠ¨æœåŠ¡ç«¯
2. å¯åŠ¨å¤šä¸ªå®¢æˆ·ç«¯ï¼Œéƒ½é…ç½®è·¯ç”±ä¸º `api`
3. è¯·æ±‚ `http://server:9001/gateway/api/` ä¼šè‡ªåŠ¨è½®è¯¢åˆ†å‘åˆ°ä¸åŒå®¢æˆ·ç«¯

### ç¤ºä¾‹ 3ï¼šå¤šæœåŠ¡éš”ç¦»

1. å¯åŠ¨æœåŠ¡ç«¯
2. å¯åŠ¨å®¢æˆ·ç«¯ Aï¼Œé…ç½®è·¯ç”±ä¸º `service-a`ï¼Œåç«¯ä¸º `http://localhost:8080`
3. å¯åŠ¨å®¢æˆ·ç«¯ Bï¼Œé…ç½®è·¯ç”±ä¸º `service-b`ï¼Œåç«¯ä¸º `http://localhost:8081`
4. è®¿é—®ï¼š
   - `http://server:9001/gateway/service-a/` â†’ æœåŠ¡ A
   - `http://server:9001/gateway/service-b/` â†’ æœåŠ¡ B

## ğŸ”§ æŠ€æœ¯æ ˆ

- Spring Boot 2.7.18
- Spring WebSocket
- Jacksonï¼ˆJSON åºåˆ—åŒ–ï¼‰
- RestTemplateï¼ˆHTTP å®¢æˆ·ç«¯ï¼‰
- CompletableFutureï¼ˆå¼‚æ­¥è¯·æ±‚å¤„ç†ï¼‰

## ğŸ“Š ç®¡ç†ç•Œé¢

è®¿é—® `http://server:9001/admin.html` æ‰“å¼€ç®¡ç†æ§åˆ¶å°ï¼ŒåŠŸèƒ½åŒ…æ‹¬ï¼š

- å®æ—¶æŸ¥çœ‹å·²æ³¨å†Œè·¯ç”±å’Œå®¢æˆ·ç«¯æ•°é‡
- æŸ¥çœ‹å®¢æˆ·ç«¯åˆ—è¡¨å’Œæœ€åå¿ƒè·³æ—¶é—´
- å¼ºåˆ¶ä¸‹çº¿æŒ‡å®šè·¯ç”±çš„æ‰€æœ‰å®¢æˆ·ç«¯
- å¼ºåˆ¶ä¸‹çº¿æŒ‡å®šå®¢æˆ·ç«¯
- è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯ 5 ç§’ï¼‰

## ğŸ”’ æ³¨æ„äº‹é¡¹

1. **å¿ƒè·³è¶…æ—¶**ï¼šå®¢æˆ·ç«¯è¶…è¿‡ 60 ç§’æ— å¿ƒè·³ä¼šè¢«è‡ªåŠ¨æ–­å¼€
2. **è¯·æ±‚è¶…æ—¶**ï¼šç½‘å…³è¯·æ±‚è¶…æ—¶æ—¶é—´ä¸º 30 ç§’
3. **ç”Ÿäº§ç¯å¢ƒ**ï¼šå»ºè®®é…ç½®è®¤è¯å’Œ HTTPSï¼Œé¿å…æœªæˆæƒè®¿é—®
4. **æ€§èƒ½**ï¼šå•æœåŠ¡ç«¯æ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯ï¼Œå»ºè®®æ ¹æ®è´Ÿè½½æƒ…å†µéƒ¨ç½²å¤šä¸ªæœåŠ¡ç«¯å®ä¾‹

## ğŸ“ é¡¹ç›®ç»“æ„

```
tunnel/
â”œâ”€â”€ tunnel-client/          # å®¢æˆ·ç«¯æ¨¡å—
â”‚   â””â”€â”€ src/main/
â”‚       â”œâ”€â”€ java/com/hanteng/tunnel/client/
â”‚       â”‚   â”œâ”€â”€ ClientApplication.java
â”‚       â”‚   â”œâ”€â”€ ws/TunnelClient.java
â”‚       â”‚   â””â”€â”€ protocol/
â”‚       â””â”€â”€ resources/
â”‚           â””â”€â”€ application.yml
â”œâ”€â”€ tunnel-server/          # æœåŠ¡ç«¯æ¨¡å—
â”‚   â””â”€â”€ src/main/
â”‚       â”œâ”€â”€ java/com/hanteng/tunnel/server/
â”‚       â”‚   â”œâ”€â”€ ServerApplication.java
â”‚       â”‚   â”œâ”€â”€ ws/TunnelWebSocketHandler.java
â”‚       â”‚   â”œâ”€â”€ http/GatewayController.java
â”‚       â”‚   â”œâ”€â”€ admin/AdminController.java
â”‚       â”‚   â”œâ”€â”€ registry/
â”‚       â”‚   â”‚   â”œâ”€â”€ RouteRegistry.java
â”‚       â”‚   â”‚   â””â”€â”€ ClientSession.java
â”‚       â”‚   â”œâ”€â”€ lb/RoundRobinLoadBalancer.java
â”‚       â”‚   â”œâ”€â”€ scheduler/HeartbeatChecker.java
â”‚       â”‚   â””â”€â”€ protocol/
â”‚       â””â”€â”€ resources/
â”‚           â”œâ”€â”€ static/admin.html
â”‚           â””â”€â”€ application.yml
â””â”€â”€ README.md
```
